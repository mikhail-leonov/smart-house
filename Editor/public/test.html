<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Custom Drag & Drop jsTree</title>
  <link rel="stylesheet" href="jstree.css" />
  <script src="jquery.js"></script>
  <script src="jstree.js"></script>
  <style>
    body { font-family: sans-serif; display: flex; gap: 3em; margin: 2em; }
    #external, #tree { border: 1px solid #ccc; padding: 1em; width: 300px; }
  </style>
</head>

<body>

<div>
  <h3>External Items</h3>
  <div id="external"></div>
</div>

<div>
  <h3>Main Tree</h3>
  <div id="tree"></div>
</div>

<script>
  // External list of draggable items
  const sensors = [
    {
        "water_leak": { "values": [0,1], "description": "Indicates if any water leaks are detected. 0 means no leak, 1 means leak detected." },
        "battery_level": { "values": [0,1], "description": "Represents the battery status. 0 means normal level, 1 means low battery warning." },
        "nas": { "values": [0,1], "description": "Shows the status of the NAS device. 0 means it is offline or unreachable, 1 means it is online and functioning." },
        "light_level": { "min_value": 0, "max_value": 500, "actions": "on, dim, off", "description": "Represents the ambient light level. Higher values mean brighter environments." },
        "occupancy": { "values": [0,1,2,3,4,5,6,7,8,9], "description": "Indicates the number of detected occupants in the room, from 0 up to 9." },
        "temperature": { "min_value": -10, "max_value": 50, "description": "Current temperature reading in degrees Celsius." },
        "humidity": { "min_value": 0, "max_value": 100, "description": "Current humidity level as a percentage." },
        "motion_detected": { "values": [0,1], "description": "Indicates if motion has been detected. 0 means no motion, 1 means motion detected." },
        "smoke_detected": { "values": [0,1], "description": "Indicates presence of smoke. 0 means normal, 1 means smoke detected." },
        "window_status": { "values": ["opened","closed","locked","opening","closing"], "actions": "open, close, lock, unlock", "description": "Shows the current status of the window. Can be opened, closed, locked, or in transition." },
        "shatter_status": {  "values": ["opened","closed","opening","closing"], "actions": "open, close", "description": "Represents the state of a shatter-sensitive surface such as glass. Can be opened, closed, or transitioning." },
        "fan_status": { "min_value": 0, "max_value": 1000, "actions": "start, stop", "description": "Current speed or load of the fan device. Actions can start or stop it." },
        "water_leak": { "values": [0,1], "description": "Indicates if any water leaks are detected. 0 means no leak, 1 means leak detected." },
        "water_leak_sensor_battery": { "min_value": 0, "max_value": 100, "description": "Battery level of the water leak sensor expressed as a percentage." },
        "stove_status": { "values": [0,1], "description": "Indicates whether the stove is off (0) or on (1)." },
        "microwave_status": { "values": [0,1], "description": "Indicates whether the microwave is off (0) or on (1)." },
        "fridge_temp": { "min_value": -10, "max_value": 10, "description": "Represents the current temperature inside the fridge in degrees Celsius." },
        "kettle_status": { "values": ["empty","heating","hot","warm","cold"], "description": "Describes the current status of the kettle based on temperature and water level." },
        "washer_status": { "values": [0,1], "description": "Indicates whether the washer is on (1) or off (0)." },
        "dryer_status": { "values": [0,1], "description": "Indicates whether the dryer is on (1) or off (0)." },
        "car_presence": { "values": [0, 1], "description": "Indicates whether a car is present (1) or not (0)" },
        "door_status": { "values": ["open","opening","closed","closing"], "actions": "open, close, lock, unlock", "description": "Current state of the door. Can be open, closed, or locked." },
        "tv_status": { "values": ["on","off"], "actions": "on, off", "description": "Indicates whether the TV is currently turned on or off." },
        "ac_status": { "values": [0,1], "description": "Indicates the power state of the AC. 0 means off, 1 means on." },
        "ac_target_temperature": { "min_value": -10, "max_value": 50, "actions": "set" },
        "soil_temperature": { "min_value": -10, "max_value": 50, "description": "Soil temperature in degrees Celsius" },
        "soil_moisture": { "min_value": 0, "max_value": 100, "description": "Soil moisture level in percentage" },
        "sprinkler_status": { "values": [0,1], "description": "Represents the operational state of the sprinkler: 1 for active/on, 0 for inactive/off" },
        "water_temperature": { "min_value": 0, "max_value": 40, "description": "Temperature of water in degrees Celsius, typically measured in pipes or tanks" },
        "vac_status": { "values": ["on","off"], "description": "Status of the vacuum system: 'on' when active, 'off' when idle or disabled" },
        "sprinkler_controller_status": { "values": [0,1], "actions": "on, off", "description": "Indicates the current status of the sprinkler controller: 1 for on, 0 for off" },
        "car_presence": { "values": [0, 1], "description": "Indicates whether a car is present (1) or not (0)" },
        "dew_point": {  "min_value": -20, "max_value": 35, "description": "Dew point temperature in degrees Celsius" },
        "pressure": { "min_value": 500, "max_value": 1500, "description": "Atmospheric pressure in hPa" },
        "cloud_cover": { "min_value": 0, "max_value": 100, "description": "Cloud cover in percentage" },
        "visibility": { "min_value": 0, "max_value": 100, "description": "Visibility distance percentage" },
        "wind_speed": {  "min_value": 0, "max_value": 500, "description": "Wind speed in cm/s" },
        "wind_direction": { "values": ["N", "NE", "E", "SE", "S", "SW", "W", "NW"], "description": "Cardinal wind direction" },
        "wind_gusts": { "min_value": 0, "max_value": 500, "description": "Peak wind gusts in cm/s" },
        "precipitation": { "min_value": 0, "max_value": 500, "description": "Precipitation in mm" },
        "precipitation_probability": { "min_value": 0, "max_value": 100, "description": "Probability of precipitation in percentage" },
        "weather_code": { "values": [0, 1, 2, 3, "..."], "description": "Weather condition code" },
        "pm10": { "min_value": 0, "max_value": 500, "description": "PM10 concentration" },
        "pm2_5": { "min_value": 0, "max_value": 500, "description": "PM2.5 concentration" },
        "carbon_monoxide": { "min_value": 0, "max_value": 100, "description": "Carbon monoxide concentration in ppm" },
        "carbon_dioxide": {  "min_value": 0, "max_value": 5000, "description": "Carbon dioxide concentration in ppm" },
        "nitrogen_dioxide": {  "min_value": 0, "max_value": 500, "description": "Nitrogen dioxide concentration" },
        "sulphur_dioxide": {  "min_value": 0, "max_value": 500, "description": "Sulphur dioxide concentration" },
        "ozone": { "min_value": 0, "max_value": 500, "description": "Ozone concentration" },
        "ammonia": { "min_value": 0, "max_value": 500, "description": "Ammonia concentration" },
        "methane": {  "min_value": 0, "max_value": 5000, "description": "Methane concentration" },
        "aerosol_optical_depth": { "min_value": 0, "max_value": 2, "description": "Aerosol optical depth (dimensionless)" },
        "dust": {  "min_value": 0, "max_value": 1000, "description": "Dust particle concentration" },
        "uv_index": { "min_value": 0, "max_value": 11, "description": "UV radiation index" },
        "alder_pollen": {  "min_value": 0, "max_value": 1000, "description": "Alder pollen count in grains/m?" },
        "birch_pollen": {  "min_value": 0, "max_value": 1000, "description": "Birch pollen count in grains/m?" },
        "grass_pollen": {  "min_value": 0, "max_value": 1000, "description": "Grass pollen count in grains/m?" },
        "mugwort_pollen": {  "min_value": 0, "max_value": 1000, "description": "Mugwort pollen count in grains/m?" },
        "olive_pollen": { "min_value": 0, "max_value": 1000, "description": "Olive pollen count in grains/m?" },
        "ragweed_pollen": { "min_value": 0, "max_value": 1000, "description": "Ragweed pollen count in grains/m?" },
        "soil_temperature": { "min_value": -10, "max_value": 50, "description": "Soil temperature in degrees Celsius" },
        "soil_moisture": { "min_value": 0, "max_value": 100, "description": "Soil moisture level in percentage" },
        "wave_height": { "min_value": 0, "max_value": 20, "description": "Wave height in meters" },
        "wave_direction": { "min_value": 0, "max_value": 360, "description": "Wave direction in degrees" },
        "wave_period": {  "min_value": 1, "max_value": 20, "description": "Wave period in seconds" },
        "wind_wave_height": {  "min_value": 0, "max_value": 20, "description": "Height of wind waves in meters" },
        "wind_wave_direction": {  "values": ["N", "NE", "E", "SE", "S", "SW", "W", "NW"], "description": "Direction of wind waves" },
        "wind_wave_period": {  "min_value": 1, "max_value": 20, "description": "Period of wind waves in seconds" },
        "swell_wave_direction": { "values": ["N", "NE", "E", "SE", "S", "SW", "W", "NW"], "description": "Swell wave direction" },
        "swell_wave_height": {  "min_value": 0, "max_value": 20, "description": "Height of swell waves in meters" },
        "swell_wave_period": {  "min_value": 1, "max_value": 20, "description": "Swell wave period in seconds" },
        "sea_level_height_msl": {  "min_value": -10, "max_value": 10, "description": "Sea level height above mean sea level in meters" },
        "sea_surface_temperature": {  "min_value": -2, "max_value": 35, "description": "Temperature of sea surface in degrees Celsius" },
        "ocean_current_velocity": {  "min_value": 0, "max_value": 3, "description": "Velocity of ocean current in m/s" },
        "ocean_current_direction": {  "values": ["N", "NE", "E", "SE", "S", "SW", "W", "NW"], "description": "Direction of ocean current" }
    }
];


  // Main tree structure
  const fsTree = {
	  "home": {
		"inside": {
		  "house": {
			"warnings": {}
		  },
		  "first_floor": {
			"office-1f": {},
			"bathroom-1f": {},
			"living-room-1f": {},
			"dining-area-1f": {},
			"kitchen-1f": {},
			"corridor-1f": {},
			"stairs-1f": {},
			"laundry-1f": {},
			"closet-1f": {},
			"garage-1f": {},
			"hall-1f": {}
		  },
		  "second_floor": {
			"master-bedroom-2f": {},
			"master-bathroom-2f": {},
			"master-closet-2f": {},
			"stairs-2f": {},
			"bathroom-2f": {},
			"hall-2f": {},
			"daria-bedroom-2f": {},
			"ivan-bedroom-2f": {},
			"den-2f": {},
			"conditioner-2f": {}
		  }
		},
		"outside": {
		  "first_floor": {
			"backyard": {},
			"pool": {},
			"home-left": {},
			"pool-area": {},
			"ac-area": {},
			"water-area": {},
			"sprinkler-area": {},
			"frontyard": {},
			"driveway": {},
			"weather": {}
		  }
		}
	  }
	};

	function convertToJsTreeData(obj, icon) {
		const ignoreKeys = new Set(['description', 'values', 'min_value', 'max_value', 'actions']);
		const result = [];
		for (const [key, value] of Object.entries(obj)) {
			if (ignoreKeys.has(key)) continue; // Skip unwanted keys
			const node = { 
				text: key, 
				id: key + "-" + Math.random().toString(36).slice(2, 8),
				icon: icon
			};
			// Only include children if the value is an object and has any non-ignored keys
			if (value && typeof value === 'object') {
				const childNodes = convertToJsTreeData(value);
				if (childNodes.length > 0) {
					node.children = childNodes;
				}
			}
			result.push(node);
		}
		return result;
	}

	// Initialize external list as another tree (but no dnd allowed inside it)
	$('#external').jstree({
		'core': {
			'data': convertToJsTreeData(sensors[0], 'sensor.svg' ),
			'check_callback': false
		},
		'plugins': ['dnd']
	});
	// Initialize main fs tree
	$('#tree').jstree({
		'core': {
			'check_callback': function (operation, node, parent, position, more) {
				const tree = $('#tree').jstree(true);
				// Block internal drag-and-drop
				if (operation === "move_node" && more && more.origin === tree) {
					return false;
				}
				// Allow drop only if target parent is a leaf node
				if (operation === "move_node" && parent) {
					const parentNode = tree.get_node(parent);
					// If parent has any children already (excluding the moving node), it's not a leaf
					const isLeaf = !parentNode.children || parentNode.children.length === 0;
					return isLeaf;
				}
				// Default: allow everything else
				return true;
			},
			'data': convertToJsTreeData(fsTree, '')
		},
		'plugins': ['dnd']
	}).on('ready.jstree', function () {
		$('#tree').jstree('open_all');  // Expand all nodes after loading
	});
</script>
</body>
</html>
