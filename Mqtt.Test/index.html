<!DOCTYPE html>
<!-- 
/**
 * SmartHub - AI powered Smart Home
 * UI App which is reads values from MQTT and show them to user
 * GitHub: https://github.com/mikhail-leonov/smart-house
 * 
 * @author Mikhail Leonov mikecommon@gmail.com
 * @version 0.6.8
 * @license MIT
 */
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MQTT Test Page</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="mb-4">MQTT Test Interface</h1>

  <!-- Publish Form -->
  <div class="card mb-4">
    <div class="card-header">Publish Message</div>
    <div class="card-body">
      <div class="mb-3">
        <label for="pub-topic" class="form-label">Topic</label>
        <input type="text" id="pub-topic" class="form-control" placeholder="e.g. test/topic" value="test/topic">
      </div>
      <div class="mb-3">
        <label for="pub-message" class="form-label">Message</label>
        <input type="text" id="pub-message" class="form-control" placeholder='e.g. {"value": 42}' value="{'value': 42}">
      </div>
      <button id="publish-btn" class="btn btn-primary">Publish</button>
    </div>
  </div>

  <!-- Subscribe Form -->
  <div class="card mb-4">
    <div class="card-header">Subscribe to Topic</div>
    <div class="card-body">
      <div class="mb-3">
        <label for="sub-topic" class="form-label">Topic</label>
        <input type="text" id="sub-topic" class="form-control" placeholder="e.g. test/#" value="test/topic">
      </div>
      <button id="subscribe-btn" class="btn btn-success">Subscribe</button>
    </div>
  </div>

  <!-- Message Log -->
  <div class="card">
    <div class="card-header">Received Messages</div>
    <div class="card-body">
      <ul id="message-log" class="list-group small"></ul>
    </div>
  </div>
</div>

<script>
  const mqttBrokerUrl = "ws://mqtt.jarvis.home:9001";
  const client = mqtt.connect(mqttBrokerUrl);

  client.on('connect', () => {
    console.log("Connected to MQTT broker");
  });

  client.on('error', (err) => {
    console.error("MQTT error:", err);
  });

  // Publish handler
  document.getElementById('publish-btn').addEventListener('click', () => {
    const topic = document.getElementById('pub-topic').value.trim();
    const message = document.getElementById('pub-message').value.trim();
    if (topic && message) {
      client.publish(topic, message);
      console.log(`Published to ${topic}: ${message}`);
    }
  });

  // Subscribe handler
  document.getElementById('subscribe-btn').addEventListener('click', () => {
    const topic = document.getElementById('sub-topic').value.trim();
    if (topic) {
      client.subscribe(topic, (err) => {
        if (err) {
          console.error(`Failed to subscribe to ${topic}`, err);
        } else {
          console.log(`Subscribed to ${topic}`);
        }
      });
    }
  });

  // Message handler
  client.on('message', (topic, payload) => {
    const message = payload.toString();
    const logEntry = document.createElement('li');
    logEntry.className = "list-group-item";
    logEntry.textContent = `${new Date().toLocaleTimeString()} | ${topic}: ${message}`;
    document.getElementById('message-log').prepend(logEntry);
  });
</script>

</body>
</html>
