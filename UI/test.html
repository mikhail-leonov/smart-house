<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SmartHub Reactive Store with MQTT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script> <!-- MQTT.js for browser -->
</head>
<body> 
  <div class="container">
    <h1 class="mb-4">SmartHub Reactive Store with MQTT</h1>

    <div class="mb-3">
      <label class="form-label" for="userNameInput">Name:</label>
      <input type="text" id="userNameInput" class="form-control" data-bind-input="username" placeholder="Enter your name">
    </div>

    <div class="mb-3">
      <label class="form-label" for="locationInput">Location:</label>
      <input type="text" id="locationInput" class="form-control" data-bind-input="location" placeholder="Enter your location">
    </div>

    <hr>

    <p>Name (live): <span data-bind="username"></span></p>
    <p>Location (live): <span data-bind="location"></span></p>
    <p>leak (live): <span data-bind="home/inside/house/warnings/water_leak"></span></p>
	

  </div>

  <script>
    class Store {
      constructor(initial = {}) {
        this.data = { ...initial };
        this.subscribers = {};
      }

      subscribe(prop, callback) {
        if (!this.subscribers[prop]) {
          this.subscribers[prop] = new Set();
        }
        this.subscribers[prop].add(callback);
        callback(this.data[prop]);
      }

      set(prop, value) {
        this.data[prop] = value;
        if (this.subscribers[prop]) {
          for (let cb of this.subscribers[prop]) {
            cb(value);
          }
        }
      }

      get(prop) {
        return this.data[prop];
      }
    }

    const store = new Store({
      username: "Guest",
      location: "Earth"
    });

    // Bind store to display elements
    document.querySelectorAll('[data-bind]').forEach(el => {
      const prop = el.getAttribute('data-bind');
      store.subscribe(prop, value => {
        el.textContent = value ?? '';
      });
    });

    // Bind inputs to store
    document.querySelectorAll('[data-bind-input]').forEach(el => {
      const prop = el.getAttribute('data-bind-input');
      el.addEventListener('input', () => {
        store.set(prop, el.value);
        // Optional: publish changes to MQTT
        if (client?.connected) {
          client.publish(`smarthub/${prop}`, el.value);
        }
      });
      store.subscribe(prop, value => {
        if (el.value !== value) el.value = value;
      });
    });

    // --- MQTT Setup ---
    const client = mqtt.connect('ws://mqtt.jarvis.home:9001');

    client.on('connect', () => {
      console.log("MQTT connected");
      client.subscribe('#');
    });

    client.on('message', (topic, message) => {
      const [, prop] = topic.split('/');
      const value = message.toString();
      if (prop in store.data) {
        store.set(prop, value);
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
